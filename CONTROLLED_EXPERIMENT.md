# æ§åˆ¶å˜é‡å®éªŒæŒ‡å—

## ğŸ¯ å®éªŒç›®çš„

**ç ”ç©¶é—®é¢˜**: åœ¨ç›¸åŒç³»ç»Ÿå‹åŠ›ä¸‹ï¼Œæ¶ˆæ¯å¤§å°å¦‚ä½•å½±å“å»¶è¿Ÿï¼Ÿ

**æ§åˆ¶å˜é‡**: å›ºå®šååé‡ ~2.5 MB/s
**è‡ªå˜é‡**: æ¶ˆæ¯å¤§å° (256B, 1KB, 4KB, 16KB, 64KB)
**å› å˜é‡**: å»¶è¿Ÿ (P50, P99, P99.9)

---

## ğŸ“‹ å®éªŒè®¾è®¡

### ä¸ºä»€ä¹ˆè¦æ§åˆ¶ååé‡ï¼Ÿ

âŒ **é”™è¯¯åšæ³•**: æ‰€æœ‰æµ‹è¯•éƒ½ç”¨ 1000 msg/s
```
256B Ã— 1000 = 0.24 MB/s   â† Kafkaå¾ˆè½»æ¾
64KB Ã— 1000 = 62.5 MB/s   â† Kafkaæ’‘ä¸ä½ï¼
```
**é—®é¢˜**: ç³»ç»Ÿå‹åŠ›ä¸åŒï¼Œå»¶è¿Ÿæ— æ³•å¯¹æ¯”

âœ… **æ­£ç¡®åšæ³•**: æ‰€æœ‰æµ‹è¯•éƒ½ç”¨ ~2.5 MB/s
```
256B Ã— 10000 = 2.4 MB/s   â† ç³»ç»Ÿå‹åŠ›ç›¸åŒ
1KB  Ã— 2500  = 2.4 MB/s   â† ç³»ç»Ÿå‹åŠ›ç›¸åŒ
4KB  Ã— 650   = 2.5 MB/s   â† ç³»ç»Ÿå‹åŠ›ç›¸åŒ
16KB Ã— 160   = 2.5 MB/s   â† ç³»ç»Ÿå‹åŠ›ç›¸åŒ
64KB Ã— 40    = 2.5 MB/s   â† ç³»ç»Ÿå‹åŠ›ç›¸åŒ
```
**ä¼˜åŠ¿**: å…¬å¹³å¯¹æ¯”ï¼Œç§‘å­¦ä¸¥è°¨

---

## ğŸ§ª å®éªŒé…ç½®

| æ¶ˆæ¯å¤§å° | Agents | Rate/Agent | æ€»msg/s | æ€»MB/s | è¯´æ˜ |
|---------|--------|-----------|---------|--------|------|
| 256 B | 10 | 200 | 2000 | 0.49 | å°æ¶ˆæ¯é«˜å¹¶å‘ |
| 1 KB | 10 | 100 | 1000 | 0.98 | åŸºçº¿é…ç½® |
| 4 KB | 10 | 65 | 650 | 2.53 | ä¸­ç­‰æ¶ˆæ¯ |
| 16 KB | 10 | 16 | 160 | 2.50 | å¤§æ¶ˆæ¯ |
| 64 KB | 10 | 4 | 40 | 2.50 | è¶…å¤§æ¶ˆæ¯ |

---

## ğŸš€ è¿è¡Œå®éªŒ

### ä¸€é”®è¿è¡Œå®Œæ•´å®éªŒ

```bash
cd /Users/lbw1125/Desktop/openmessaging-benchmark

# è¿è¡Œæ‰€æœ‰5ä¸ªæµ‹è¯•ï¼ˆçº¦15åˆ†é’Ÿï¼‰
bash run_controlled_experiment.sh

# é‡å‘½åç»“æœæ–‡ä»¶
bash rename_controlled_results.sh

# åˆ†æç»“æœ
python analyze_controlled_experiment.py
```

### å•ç‹¬è¿è¡ŒæŸä¸ªæµ‹è¯•

```bash
# ä¾‹å¦‚ï¼šåªæµ‹è¯•64KB
cat > /tmp/test-workload.yaml << 'EOF'
name: msg-size-65536B-controlled
topics: 1
partitionsPerTopic: 10
messageSize: 65536
keyDistributor: RANDOM_NANO
subscriptionsPerTopic: 1
producersPerTopic: 10
consumerPerSubscription: 10
producerRate: 4
testDurationMinutes: 2
warmupDurationMinutes: 0
EOF

python -m benchmark.benchmark -d examples/kafka-driver.yaml /tmp/test-workload.yaml
```

---

## ğŸ“Š é¢„æœŸç»“æœ

### å‡è®¾1: å»¶è¿Ÿä¸æ¶ˆæ¯å¤§å°çº¿æ€§ç›¸å…³

å¦‚æœæˆç«‹ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
```
256B  â†’ P99 ~500ms
1KB   â†’ P99 ~800ms   (4å€å¤§å°, 1.6å€å»¶è¿Ÿ)
4KB   â†’ P99 ~1500ms  (16å€å¤§å°, 3å€å»¶è¿Ÿ)
16KB  â†’ P99 ~3000ms  (64å€å¤§å°, 6å€å»¶è¿Ÿ)
64KB  â†’ P99 ~5000ms  (256å€å¤§å°, 10å€å»¶è¿Ÿ)
```

### å‡è®¾2: å¤§æ¶ˆæ¯æœ‰æ‰¹å¤„ç†ä¼˜åŠ¿

å¦‚æœæˆç«‹ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
```
å»¶è¿Ÿå¢é•¿ < æ¶ˆæ¯å¤§å°å¢é•¿
ä¾‹å¦‚: 64KBæ¶ˆæ¯ = 256å€å¤§å°ï¼Œä½†å»¶è¿Ÿåªå¢åŠ 5å€
```

### å‡è®¾3: å¤§æ¶ˆæ¯æœ‰é¢å¤–å¼€é”€

å¦‚æœæˆç«‹ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
```
å»¶è¿Ÿå¢é•¿ > æ¶ˆæ¯å¤§å°å¢é•¿
ä¾‹å¦‚: 64KBæ¶ˆæ¯ = 256å€å¤§å°ï¼Œå»¶è¿Ÿå¢åŠ 20å€
```

---

## ğŸ“ˆ æ•°æ®å¯è§†åŒ–å»ºè®®

å¯ä»¥ç”¨Pythonç»˜åˆ¶å›¾è¡¨ï¼š

```python
import matplotlib.pyplot as plt

sizes = [256, 1024, 4096, 16384, 65536]
p99_latencies = [...]  # ä»ç»“æœä¸­æå–

plt.figure(figsize=(10, 6))
plt.plot(sizes, p99_latencies, 'o-', linewidth=2, markersize=8)
plt.xlabel('Message Size (bytes)', fontsize=12)
plt.ylabel('P99 Latency (ms)', fontsize=12)
plt.title('Message Size vs Latency (Controlled Throughput ~2.5 MB/s)', fontsize=14)
plt.xscale('log')
plt.grid(True, alpha=0.3)
plt.savefig('controlled_experiment_results.png', dpi=300, bbox_inches='tight')
plt.show()
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç¡¬ä»¶é™åˆ¶ï¼ˆä½ çš„Macï¼‰
- åŒæ ¸CPUï¼Œ2ä¸ªé€»è¾‘æ ¸å¿ƒç»™Docker
- 64KBé…ç½®å·²ç»æ˜¯æé™
- å¦‚æœå‡ºç°Timeoutï¼Œè¯´æ˜è¶…å‡ºç¡¬ä»¶èƒ½åŠ›

### 2. æµ‹è¯•é—´éš”
- æ¯ä¸ªæµ‹è¯•åç­‰å¾…10ç§’
- è®©Kafkaæ¸…ç©ºå†…å­˜å’Œåˆ·æ–°ç£ç›˜

### 3. ç»“æœæœ‰æ•ˆæ€§
- æ£€æŸ¥ `publishErrorRate` åº”è¯¥ = 0
- æ£€æŸ¥ `backlog` åº”è¯¥ < 1000
- å¦‚æœä¸æ»¡è¶³ï¼Œè¯´æ˜æµ‹è¯•æ— æ•ˆ

---

## ğŸ“ è®ºæ–‡å†™ä½œå»ºè®®

### å®éªŒè®¾ç½®ç« èŠ‚

```
æˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ªæ§åˆ¶å˜é‡å®éªŒæ¥ç ”ç©¶æ¶ˆæ¯å¤§å°å¯¹å»¶è¿Ÿçš„å½±å“ã€‚
ä¸ºäº†ä¿è¯å…¬å¹³å¯¹æ¯”ï¼Œæˆ‘ä»¬å›ºå®šç³»ç»Ÿååé‡ä¸º2.5 MB/sï¼Œ
é€šè¿‡è°ƒæ•´æ¶ˆæ¯é€Ÿç‡æ¥é€‚é…ä¸åŒçš„æ¶ˆæ¯å¤§å°ã€‚

å®éªŒç¯å¢ƒï¼š
- Kafka 7.5.0 (å•èŠ‚ç‚¹, Docker)
- ç¡¬ä»¶: MacBook Pro (åŒæ ¸, 16GBå†…å­˜)
- æµ‹è¯•å·¥å…·: è‡ªç ”benchmarkæ¡†æ¶
- é…ç½®: 10ä¸ªç”Ÿäº§è€…, 10ä¸ªæ¶ˆè´¹è€…, 1ä¸ªtopic, 10ä¸ªåˆ†åŒº
```

### ç»“æœåˆ†æç« èŠ‚

```
ç»“æœæ˜¾ç¤ºï¼Œå½“ååé‡å›ºå®šæ—¶ï¼ŒP99å»¶è¿Ÿéšæ¶ˆæ¯å¤§å°å‘ˆ[çº¿æ€§/è¶…çº¿æ€§/æ¬¡çº¿æ€§]å¢é•¿ã€‚
ä»256Båˆ°64KBï¼ˆ256å€å¤§å°ï¼‰ï¼ŒP99å»¶è¿Ÿä»Xmså¢åŠ åˆ°Ymsï¼ˆZå€å¢é•¿ï¼‰ã€‚
è¿™è¡¨æ˜[æ‰¹å¤„ç†ä¼˜åŠ¿/ç½‘ç»œå¼€é”€/...]æ˜¯ä¸»è¦å½±å“å› ç´ ã€‚
```

---

## ğŸ“ ç§‘å­¦æ€§ä¿è¯

âœ… **æ§åˆ¶å˜é‡**: ååé‡å›ºå®š
âœ… **é‡å¤æ€§**: å¯é‡ç°çš„å®éªŒé…ç½®
âœ… **æ•°æ®å®Œæ•´**: è®°å½•æ‰€æœ‰å»¶è¿Ÿåˆ†ä½æ•°
âœ… **ç¯å¢ƒè®°å½•**: æ–‡æ¡£åŒ–ç¡¬ä»¶å’Œè½¯ä»¶é…ç½®
âœ… **æœ‰æ•ˆæ€§æ£€æŸ¥**: é”™è¯¯ç‡å’Œç§¯å‹ç›‘æ§

---

## ğŸ¤” å¸¸è§é—®é¢˜

**Q: ä¸ºä»€ä¹ˆ256Bç”¨2000 msg/sï¼Œ64KBåªç”¨40 msg/sï¼Ÿ**
A: å› ä¸ºè¦ä¿æŒç›¸åŒçš„ååé‡(MB/s)ï¼Œè¿™æ ·Kafkaçš„å‹åŠ›æ‰ç›¸åŒã€‚

**Q: ä¸ºä»€ä¹ˆä¸ä¿æŒ1000 msg/sï¼Ÿ**
A: å› ä¸º64KB Ã— 1000 = 62.5 MB/sä¼šè¶…å‡ºç¡¬ä»¶èƒ½åŠ›ï¼Œæµ‹è¯•ä¼šå¤±è´¥ã€‚

**Q: ååé‡æœ‰ç‚¹ä¸ä¸€è‡´æ€ä¹ˆåŠï¼Ÿ**
A: å¯ä»¥æ¥å—Â±20%çš„è¯¯å·®ï¼Œåªè¦é”™è¯¯ç‡ä¸º0å³å¯ã€‚

---

å‡†å¤‡å¥½äº†å°±è¿è¡Œå®éªŒå§ï¼ğŸš€
